#include "cpu.h"

#define PMMU_PAGESIZE           (4 * 1024UL)
#define VBR_PROXY_IN_ROM        1

NMIFunc_t   NMIFunc;
uint32      NMIBusy;

uint32*     mmuRootTable;
uint32*     mmuInvalidPtrTable;
uint32*     mmuInvalidPageTable;
uint32*     mmuInvalidPage;
uint32*     mmuInvalidPageDesc;

uint32*     vbrTable;

void cpu_NullNMI(regs_t* r) {
}


bool cpu_Init()
{
    // set dummy nmi handler
    NMIFunc = cpu_NullNMI;
    NMIBusy = 0;

    // enable superscalar dispatch
    cpu_SetPCR(1);

    return true;
}


uint32 cpu_Detect(uint32* revout, uint32* idout)
{
    uint32 sku = CPU_UNKONWN;
    uint32 rev = 1;

    uint32 pcr = cpu_GetPCR();
    rev = (pcr >> 8) & 0xFF;
    if ((pcr & 0x000f0000) == 0)
        sku = CPU_68060;
    else if (rev == 4)
        sku = CPU_68LC060;
    else if (rev == 3)
        sku = CPU_68EC060;

    if (idout)
        *idout = pcr & 0xffffff00;

    if (revout)
        *revout = rev;

    return sku;
}


NMIFunc_t cpu_SetNMI(NMIFunc_t func)
{
    NMIFunc_t old = NMIFunc;
    NMIFunc = func;
    return old;
}


uint32* mmu_Init()
{
    mmuRootTable        = (uint32*) mem_Alloc(128 * 4, 512);
    mmuInvalidPtrTable  = (uint32*) mem_Alloc(128 * 4, 512);
    mmuInvalidPageTable = (uint32*) mem_Alloc( 64 * 4, 256);
    mmuInvalidPageDesc  = (uint32*) mem_Alloc(4, 4);
    mmuInvalidPage      = (uint32*) mem_Alloc(PMMU_PAGESIZE, PMMU_PAGESIZE);

    mmuInvalidPageDesc[0] = ((uint32)mmuInvalidPage) | (PMMU_READWRITE | PMMU_CM_WRITETHROUGH);

    for (int i=0; i<PMMU_PAGESIZE/4; i++)
        mmuInvalidPage[i] = 0;

    for (int i=0; i<64; i++)
        mmuInvalidPageTable[i] = ((uint32)mmuInvalidPageDesc) | PMMU_INDIRECT;

    for (int i=0; i<128; i++)
        mmuInvalidPtrTable[i] = ((uint32)mmuInvalidPageTable) | PMMU_READWRITE;

    for (int i=0; i<128; i++)
        mmuRootTable[i] = ((uint32)mmuInvalidPtrTable) | PMMU_READWRITE;

    return mmuRootTable;
}


uint32* mmu_GetPageDescriptor(uint32 log)
{
    const uint32 ptrTableAddressMask = ~511UL;
    const uint32 pageTableAddressMask = ~255UL;
    //const uint32 pageAddressMask = ~(PMMU_PAGESIZE - 1);
    //uint32 addr = log & ~(PMMU_PAGESIZE - 1);

    uint32 rootIdx = (log >> 25) & 127;
    uint32 ptrIdx  = (log >> 18) & 127;
    uint32 pageIdx = (log >> 12) & 63;

    uint32* ptrTable = (uint32*) (mmuRootTable[rootIdx] & ptrTableAddressMask);
    if (ptrTable == mmuInvalidPtrTable) {
        ptrTable = (uint32*) mem_Alloc(128 * 4, 512);
        for (int i=0; i<128; i++)
            ptrTable[i] = ((uint32)mmuInvalidPageTable) | PMMU_READWRITE;

        mmuRootTable[rootIdx] = ((uint32)ptrTable) | PMMU_READWRITE;
    }

    uint32* pageTable = (uint32*) (ptrTable[ptrIdx] & pageTableAddressMask);
    if (pageTable == mmuInvalidPageTable) {
        pageTable = (uint32*) mem_Alloc(64 * 4, 256);
        for (int i=0; i<64; i++)
            pageTable[i] = ((uint32)mmuInvalidPageDesc) | PMMU_INDIRECT;
        ptrTable[ptrIdx] = ((uint32)pageTable) | PMMU_READWRITE;
    }

    return &pageTable[pageIdx];
}


void mmu_Map(uint32 log, uint32 phys, uint32 size, uint32 flags)
{
    const uint32 pageAddressMask = ~(PMMU_PAGESIZE - 1);
    uint32 end = (log + size + (PMMU_PAGESIZE - 1)) & pageAddressMask;
    uint32 src = log & pageAddressMask;
    uint32 dst = phys & pageAddressMask;

    while (src != end)
    {
        uint32* pageDescriptor = mmu_GetPageDescriptor(src);
        *pageDescriptor = flags | dst;
        src += PMMU_PAGESIZE;
        dst += PMMU_PAGESIZE;
    }
}


void mmu_Redirect(uint32 logsrc, uint32 logdst, uint32 size)
{
    const uint32 pageAddressMask = ~(PMMU_PAGESIZE - 1);
    uint32 end = (logsrc + size + (PMMU_PAGESIZE - 1)) & pageAddressMask;
    uint32 src = logsrc & pageAddressMask;
    uint32 dst = logdst & pageAddressMask;

    while (src != end)
    {
        uint32* srcPageDescriptor = mmu_GetPageDescriptor(src);
        uint32* dstPageDescriptor = mmu_GetPageDescriptor(dst);
        *srcPageDescriptor = PMMU_INDIRECT | (uint32)dstPageDescriptor;
        src += PMMU_PAGESIZE;
        dst += PMMU_PAGESIZE;
    }
}


void mmu_Invalid(uint32 log, uint32 size)
{
    const uint32 pageAddressMask = ~(PMMU_PAGESIZE - 1);
    uint32 end = (log + size + (PMMU_PAGESIZE - 1)) & pageAddressMask;
    uint32 src = log & pageAddressMask;

    while (src != end)
    {
        uint32* pageDescriptor = mmu_GetPageDescriptor(src);
        *pageDescriptor &= ~3UL;
        src += PMMU_PAGESIZE;
    }
}





#if VBR_PROXY_IN_ROM
const uint16 vbrProxy[] =
{
    0x2F38, 0x0000, 0x4E75, 0x4E75, 0x2F38, 0x0004, 0x4E75, 0x4E75, 0x2F38, 0x0008, 0x4E75, 0x4E75, 0x2F38, 0x000C, 0x4E75, 0x4E75,
    0x2F38, 0x0010, 0x4E75, 0x4E75, 0x2F38, 0x0014, 0x4E75, 0x4E75, 0x2F38, 0x0018, 0x4E75, 0x4E75, 0x2F38, 0x001C, 0x4E75, 0x4E75,
    0x2F38, 0x0020, 0x4E75, 0x4E75, 0x2F38, 0x0024, 0x4E75, 0x4E75, 0x2F38, 0x0028, 0x4E75, 0x4E75, 0x2F38, 0x002C, 0x4E75, 0x4E75,
    0x2F38, 0x0030, 0x4E75, 0x4E75, 0x2F38, 0x0034, 0x4E75, 0x4E75, 0x2F38, 0x0038, 0x4E75, 0x4E75, 0x2F38, 0x003C, 0x4E75, 0x4E75,
    0x2F38, 0x0040, 0x4E75, 0x4E75, 0x2F38, 0x0044, 0x4E75, 0x4E75, 0x2F38, 0x0048, 0x4E75, 0x4E75, 0x2F38, 0x004C, 0x4E75, 0x4E75,
    0x2F38, 0x0050, 0x4E75, 0x4E75, 0x2F38, 0x0054, 0x4E75, 0x4E75, 0x2F38, 0x0058, 0x4E75, 0x4E75, 0x2F38, 0x005C, 0x4E75, 0x4E75,
    0x2F38, 0x0060, 0x4E75, 0x4E75, 0x2F38, 0x0064, 0x4E75, 0x4E75, 0x2F38, 0x0068, 0x4E75, 0x4E75, 0x2F38, 0x006C, 0x4E75, 0x4E75,
    0x2F38, 0x0070, 0x4E75, 0x4E75, 0x2F38, 0x0074, 0x4E75, 0x4E75, 0x2F38, 0x0078, 0x4E75, 0x4E75, 0x2F38, 0x007C, 0x4E75, 0x4E75,
    0x2F38, 0x0080, 0x4E75, 0x4E75, 0x2F38, 0x0084, 0x4E75, 0x4E75, 0x2F38, 0x0088, 0x4E75, 0x4E75, 0x2F38, 0x008C, 0x4E75, 0x4E75,
    0x2F38, 0x0090, 0x4E75, 0x4E75, 0x2F38, 0x0094, 0x4E75, 0x4E75, 0x2F38, 0x0098, 0x4E75, 0x4E75, 0x2F38, 0x009C, 0x4E75, 0x4E75,
    0x2F38, 0x00A0, 0x4E75, 0x4E75, 0x2F38, 0x00A4, 0x4E75, 0x4E75, 0x2F38, 0x00A8, 0x4E75, 0x4E75, 0x2F38, 0x00AC, 0x4E75, 0x4E75,
    0x2F38, 0x00B0, 0x4E75, 0x4E75, 0x2F38, 0x00B4, 0x4E75, 0x4E75, 0x2F38, 0x00B8, 0x4E75, 0x4E75, 0x2F38, 0x00BC, 0x4E75, 0x4E75,
    0x2F38, 0x00C0, 0x4E75, 0x4E75, 0x2F38, 0x00C4, 0x4E75, 0x4E75, 0x2F38, 0x00C8, 0x4E75, 0x4E75, 0x2F38, 0x00CC, 0x4E75, 0x4E75,
    0x2F38, 0x00D0, 0x4E75, 0x4E75, 0x2F38, 0x00D4, 0x4E75, 0x4E75, 0x2F38, 0x00D8, 0x4E75, 0x4E75, 0x2F38, 0x00DC, 0x4E75, 0x4E75,
    0x2F38, 0x00E0, 0x4E75, 0x4E75, 0x2F38, 0x00E4, 0x4E75, 0x4E75, 0x2F38, 0x00E8, 0x4E75, 0x4E75, 0x2F38, 0x00EC, 0x4E75, 0x4E75,
    0x2F38, 0x00F0, 0x4E75, 0x4E75, 0x2F38, 0x00F4, 0x4E75, 0x4E75, 0x2F38, 0x00F8, 0x4E75, 0x4E75, 0x2F38, 0x00FC, 0x4E75, 0x4E75,
    0x2F38, 0x0100, 0x4E75, 0x4E75, 0x2F38, 0x0104, 0x4E75, 0x4E75, 0x2F38, 0x0108, 0x4E75, 0x4E75, 0x2F38, 0x010C, 0x4E75, 0x4E75,
    0x2F38, 0x0110, 0x4E75, 0x4E75, 0x2F38, 0x0114, 0x4E75, 0x4E75, 0x2F38, 0x0118, 0x4E75, 0x4E75, 0x2F38, 0x011C, 0x4E75, 0x4E75,
    0x2F38, 0x0120, 0x4E75, 0x4E75, 0x2F38, 0x0124, 0x4E75, 0x4E75, 0x2F38, 0x0128, 0x4E75, 0x4E75, 0x2F38, 0x012C, 0x4E75, 0x4E75,
    0x2F38, 0x0130, 0x4E75, 0x4E75, 0x2F38, 0x0134, 0x4E75, 0x4E75, 0x2F38, 0x0138, 0x4E75, 0x4E75, 0x2F38, 0x013C, 0x4E75, 0x4E75,
    0x2F38, 0x0140, 0x4E75, 0x4E75, 0x2F38, 0x0144, 0x4E75, 0x4E75, 0x2F38, 0x0148, 0x4E75, 0x4E75, 0x2F38, 0x014C, 0x4E75, 0x4E75,
    0x2F38, 0x0150, 0x4E75, 0x4E75, 0x2F38, 0x0154, 0x4E75, 0x4E75, 0x2F38, 0x0158, 0x4E75, 0x4E75, 0x2F38, 0x015C, 0x4E75, 0x4E75,
    0x2F38, 0x0160, 0x4E75, 0x4E75, 0x2F38, 0x0164, 0x4E75, 0x4E75, 0x2F38, 0x0168, 0x4E75, 0x4E75, 0x2F38, 0x016C, 0x4E75, 0x4E75,
    0x2F38, 0x0170, 0x4E75, 0x4E75, 0x2F38, 0x0174, 0x4E75, 0x4E75, 0x2F38, 0x0178, 0x4E75, 0x4E75, 0x2F38, 0x017C, 0x4E75, 0x4E75,
    0x2F38, 0x0180, 0x4E75, 0x4E75, 0x2F38, 0x0184, 0x4E75, 0x4E75, 0x2F38, 0x0188, 0x4E75, 0x4E75, 0x2F38, 0x018C, 0x4E75, 0x4E75,
    0x2F38, 0x0190, 0x4E75, 0x4E75, 0x2F38, 0x0194, 0x4E75, 0x4E75, 0x2F38, 0x0198, 0x4E75, 0x4E75, 0x2F38, 0x019C, 0x4E75, 0x4E75,
    0x2F38, 0x01A0, 0x4E75, 0x4E75, 0x2F38, 0x01A4, 0x4E75, 0x4E75, 0x2F38, 0x01A8, 0x4E75, 0x4E75, 0x2F38, 0x01AC, 0x4E75, 0x4E75,
    0x2F38, 0x01B0, 0x4E75, 0x4E75, 0x2F38, 0x01B4, 0x4E75, 0x4E75, 0x2F38, 0x01B8, 0x4E75, 0x4E75, 0x2F38, 0x01BC, 0x4E75, 0x4E75,
    0x2F38, 0x01C0, 0x4E75, 0x4E75, 0x2F38, 0x01C4, 0x4E75, 0x4E75, 0x2F38, 0x01C8, 0x4E75, 0x4E75, 0x2F38, 0x01CC, 0x4E75, 0x4E75,
    0x2F38, 0x01D0, 0x4E75, 0x4E75, 0x2F38, 0x01D4, 0x4E75, 0x4E75, 0x2F38, 0x01D8, 0x4E75, 0x4E75, 0x2F38, 0x01DC, 0x4E75, 0x4E75,
    0x2F38, 0x01E0, 0x4E75, 0x4E75, 0x2F38, 0x01E4, 0x4E75, 0x4E75, 0x2F38, 0x01E8, 0x4E75, 0x4E75, 0x2F38, 0x01EC, 0x4E75, 0x4E75,
    0x2F38, 0x01F0, 0x4E75, 0x4E75, 0x2F38, 0x01F4, 0x4E75, 0x4E75, 0x2F38, 0x01F8, 0x4E75, 0x4E75, 0x2F38, 0x01FC, 0x4E75, 0x4E75,
    0x2F38, 0x0200, 0x4E75, 0x4E75, 0x2F38, 0x0204, 0x4E75, 0x4E75, 0x2F38, 0x0208, 0x4E75, 0x4E75, 0x2F38, 0x020C, 0x4E75, 0x4E75,
    0x2F38, 0x0210, 0x4E75, 0x4E75, 0x2F38, 0x0214, 0x4E75, 0x4E75, 0x2F38, 0x0218, 0x4E75, 0x4E75, 0x2F38, 0x021C, 0x4E75, 0x4E75,
    0x2F38, 0x0220, 0x4E75, 0x4E75, 0x2F38, 0x0224, 0x4E75, 0x4E75, 0x2F38, 0x0228, 0x4E75, 0x4E75, 0x2F38, 0x022C, 0x4E75, 0x4E75,
    0x2F38, 0x0230, 0x4E75, 0x4E75, 0x2F38, 0x0234, 0x4E75, 0x4E75, 0x2F38, 0x0238, 0x4E75, 0x4E75, 0x2F38, 0x023C, 0x4E75, 0x4E75,
    0x2F38, 0x0240, 0x4E75, 0x4E75, 0x2F38, 0x0244, 0x4E75, 0x4E75, 0x2F38, 0x0248, 0x4E75, 0x4E75, 0x2F38, 0x024C, 0x4E75, 0x4E75,
    0x2F38, 0x0250, 0x4E75, 0x4E75, 0x2F38, 0x0254, 0x4E75, 0x4E75, 0x2F38, 0x0258, 0x4E75, 0x4E75, 0x2F38, 0x025C, 0x4E75, 0x4E75,
    0x2F38, 0x0260, 0x4E75, 0x4E75, 0x2F38, 0x0264, 0x4E75, 0x4E75, 0x2F38, 0x0268, 0x4E75, 0x4E75, 0x2F38, 0x026C, 0x4E75, 0x4E75,
    0x2F38, 0x0270, 0x4E75, 0x4E75, 0x2F38, 0x0274, 0x4E75, 0x4E75, 0x2F38, 0x0278, 0x4E75, 0x4E75, 0x2F38, 0x027C, 0x4E75, 0x4E75,
    0x2F38, 0x0280, 0x4E75, 0x4E75, 0x2F38, 0x0284, 0x4E75, 0x4E75, 0x2F38, 0x0288, 0x4E75, 0x4E75, 0x2F38, 0x028C, 0x4E75, 0x4E75,
    0x2F38, 0x0290, 0x4E75, 0x4E75, 0x2F38, 0x0294, 0x4E75, 0x4E75, 0x2F38, 0x0298, 0x4E75, 0x4E75, 0x2F38, 0x029C, 0x4E75, 0x4E75,
    0x2F38, 0x02A0, 0x4E75, 0x4E75, 0x2F38, 0x02A4, 0x4E75, 0x4E75, 0x2F38, 0x02A8, 0x4E75, 0x4E75, 0x2F38, 0x02AC, 0x4E75, 0x4E75,
    0x2F38, 0x02B0, 0x4E75, 0x4E75, 0x2F38, 0x02B4, 0x4E75, 0x4E75, 0x2F38, 0x02B8, 0x4E75, 0x4E75, 0x2F38, 0x02BC, 0x4E75, 0x4E75,
    0x2F38, 0x02C0, 0x4E75, 0x4E75, 0x2F38, 0x02C4, 0x4E75, 0x4E75, 0x2F38, 0x02C8, 0x4E75, 0x4E75, 0x2F38, 0x02CC, 0x4E75, 0x4E75,
    0x2F38, 0x02D0, 0x4E75, 0x4E75, 0x2F38, 0x02D4, 0x4E75, 0x4E75, 0x2F38, 0x02D8, 0x4E75, 0x4E75, 0x2F38, 0x02DC, 0x4E75, 0x4E75,
    0x2F38, 0x02E0, 0x4E75, 0x4E75, 0x2F38, 0x02E4, 0x4E75, 0x4E75, 0x2F38, 0x02E8, 0x4E75, 0x4E75, 0x2F38, 0x02EC, 0x4E75, 0x4E75,
    0x2F38, 0x02F0, 0x4E75, 0x4E75, 0x2F38, 0x02F4, 0x4E75, 0x4E75, 0x2F38, 0x02F8, 0x4E75, 0x4E75, 0x2F38, 0x02FC, 0x4E75, 0x4E75,
    0x2F38, 0x0300, 0x4E75, 0x4E75, 0x2F38, 0x0304, 0x4E75, 0x4E75, 0x2F38, 0x0308, 0x4E75, 0x4E75, 0x2F38, 0x030C, 0x4E75, 0x4E75,
    0x2F38, 0x0310, 0x4E75, 0x4E75, 0x2F38, 0x0314, 0x4E75, 0x4E75, 0x2F38, 0x0318, 0x4E75, 0x4E75, 0x2F38, 0x031C, 0x4E75, 0x4E75,
    0x2F38, 0x0320, 0x4E75, 0x4E75, 0x2F38, 0x0324, 0x4E75, 0x4E75, 0x2F38, 0x0328, 0x4E75, 0x4E75, 0x2F38, 0x032C, 0x4E75, 0x4E75,
    0x2F38, 0x0330, 0x4E75, 0x4E75, 0x2F38, 0x0334, 0x4E75, 0x4E75, 0x2F38, 0x0338, 0x4E75, 0x4E75, 0x2F38, 0x033C, 0x4E75, 0x4E75,
    0x2F38, 0x0340, 0x4E75, 0x4E75, 0x2F38, 0x0344, 0x4E75, 0x4E75, 0x2F38, 0x0348, 0x4E75, 0x4E75, 0x2F38, 0x034C, 0x4E75, 0x4E75,
    0x2F38, 0x0350, 0x4E75, 0x4E75, 0x2F38, 0x0354, 0x4E75, 0x4E75, 0x2F38, 0x0358, 0x4E75, 0x4E75, 0x2F38, 0x035C, 0x4E75, 0x4E75,
    0x2F38, 0x0360, 0x4E75, 0x4E75, 0x2F38, 0x0364, 0x4E75, 0x4E75, 0x2F38, 0x0368, 0x4E75, 0x4E75, 0x2F38, 0x036C, 0x4E75, 0x4E75,
    0x2F38, 0x0370, 0x4E75, 0x4E75, 0x2F38, 0x0374, 0x4E75, 0x4E75, 0x2F38, 0x0378, 0x4E75, 0x4E75, 0x2F38, 0x037C, 0x4E75, 0x4E75,
    0x2F38, 0x0380, 0x4E75, 0x4E75, 0x2F38, 0x0384, 0x4E75, 0x4E75, 0x2F38, 0x0388, 0x4E75, 0x4E75, 0x2F38, 0x038C, 0x4E75, 0x4E75,
    0x2F38, 0x0390, 0x4E75, 0x4E75, 0x2F38, 0x0394, 0x4E75, 0x4E75, 0x2F38, 0x0398, 0x4E75, 0x4E75, 0x2F38, 0x039C, 0x4E75, 0x4E75,
    0x2F38, 0x03A0, 0x4E75, 0x4E75, 0x2F38, 0x03A4, 0x4E75, 0x4E75, 0x2F38, 0x03A8, 0x4E75, 0x4E75, 0x2F38, 0x03AC, 0x4E75, 0x4E75,
    0x2F38, 0x03B0, 0x4E75, 0x4E75, 0x2F38, 0x03B4, 0x4E75, 0x4E75, 0x2F38, 0x03B8, 0x4E75, 0x4E75, 0x2F38, 0x03BC, 0x4E75, 0x4E75,
    0x2F38, 0x03C0, 0x4E75, 0x4E75, 0x2F38, 0x03C4, 0x4E75, 0x4E75, 0x2F38, 0x03C8, 0x4E75, 0x4E75, 0x2F38, 0x03CC, 0x4E75, 0x4E75,
    0x2F38, 0x03D0, 0x4E75, 0x4E75, 0x2F38, 0x03D4, 0x4E75, 0x4E75, 0x2F38, 0x03D8, 0x4E75, 0x4E75, 0x2F38, 0x03DC, 0x4E75, 0x4E75,
    0x2F38, 0x03E0, 0x4E75, 0x4E75, 0x2F38, 0x03E4, 0x4E75, 0x4E75, 0x2F38, 0x03E8, 0x4E75, 0x4E75, 0x2F38, 0x03EC, 0x4E75, 0x4E75,
    0x2F38, 0x03F0, 0x4E75, 0x4E75, 0x2F38, 0x03F4, 0x4E75, 0x4E75, 0x2F38, 0x03F8, 0x4E75, 0x4E75, 0x2F38, 0x03FC, 0x4E75, 0x4E75,
};
#else
uint16* vbrProxy;
#endif

bool vbr_Init()
{
    vbrTable = (uint32*) mem_Alloc(256 * 4, 256);
#if VBR_PROXY_IN_ROM
    for (uint32 i=0; i<256*4; i+=4)
    {
        vbr_Set(i, (uint32) &vbrProxy[i]);
    }
#else
    vbrProxy = (uint16*) mem_Alloc(256 * 4 * 2, 256);
    uint32 addr = 0;
    for (uint32 i=0, j=0; i<256*4; i+=4, addr+=4)
    {
        vbrProxy[j++] = 0x2F38; // move.l (addr).w,-(sp)
        vbrProxy[j++] = addr;
        vbrProxy[j++] = 0x4E75; // rts
        vbrProxy[j++] = 0x4E75; // rts
        vbr_Set(i, (uint32) &vbrProxy[j-4]);
    }
#endif

    vbr_Set(0x60, (uint32) vecRTE); // IRQ0 : Spurious
    vbr_Set(0x7C, (uint32) vecNMI); // IRQ7 : NMI
    vbr_Apply();
    return true;
}


void vbr_Set(uint32 vec, uint32 addr)
{
    vbrTable[vec >> 2] = addr;
}

void vbr_Apply()
{
    cpu_SetVBR((uint32)vbrTable);
}
